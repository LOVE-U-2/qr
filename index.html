<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Advanced QR Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>

  :root{
    --bg:#071026;
    --card: rgba(255,255,255,0.04);
    --muted:#97a6b8;
    --glass: rgba(255,255,255,0.03);
    --accent1: #14b8a6;
    --accent2: #3b82f6;
    --accent-grad: linear-gradient(90deg,var(--accent1),var(--accent2));
    --radius:14px;
  }
  *{box-sizing:border-box;font-family:'Poppins',sans-serif}
  body {
  margin: 0;
  min-height: 100vh;
  background: radial-gradient(1200px 600px at 10% 10%, rgb(7, 100, 89), transparent),
              linear-gradient(180deg,#190768 0%, #3c051e 100%);
  color: #e9f0f7;
  padding: 28px;
  padding-top: 100px; /* Header ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶ú‡¶æ‡ßü‡¶ó‡¶æ */
  display: flex;
  align-items: flex-start;
  justify-content: center;
  gap: 18px;
}

  .wrap{
    width:1200px;
    max-width:100%;
    display:grid;
    grid-template-columns:440px 1fr;
    gap:22px;
    align-items:start;
  }
  .card{
    background:var(--card);
    border-radius:var(--radius);
    padding:18px;
    box-shadow: 0 12px 30px rgba(2,6,23,0.6);
    border: 1px solid rgba(255,255,255,0.03);
    
    height: calc(100vh - 64px);
    overflow-y: auto;
    padding-right:12px;
  }
  /* Custom scrollbar (WebKit + fallback) */
  .card::-webkit-scrollbar{width:10px}
  .card::-webkit-scrollbar-track{background:transparent}
  .card::-webkit-scrollbar-thumb{background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.06));border-radius:10px}
  .card::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg, rgba(93, 220, 255, 0.719), rgba(53, 4, 133, 0.532));}
  
  h1{margin:0 0 6px;font-size:20px;letter-spacing:-0.2px}
  label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
  input, select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:#071328;color:#e8f0f7;font-size:14px}
  input[type="color"]{height:40px;padding:4px}
  .row{display:flex;gap:8px}
  .row > *{flex:1}
  .small{width:120px}
  .btn{
    display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:0;
    background:var(--accent-grad);color:#04201a;font-weight:700;cursor:pointer;box-shadow:0 8px 18px rgba(59,130,246,0.12)
  }
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  .muted{color:var(--muted);font-size:13px}
  /* --- Preview area wider --- */
.preview-area {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  gap: 18px;
  padding: 18px;
  min-height: 500px;
  width: 100%;
  margin-left: auto;
  margin-right: auto;
}

.preview-card {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));
  border-radius: 12px;
  padding: 24px;
  width: 100%;
  max-width: 800px; /* ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶ö‡ßá‡ßü‡ßá ‡¶¨‡ßú */
  display: flex;
  flex-direction: column;
  gap: 20px;
  align-items: center;
  box-shadow: inset 0 2px 1px rgba(255, 255, 255, 0.249);
}
.designer{display:flex;align-items:center;gap:12px}
  .designer .brand{font-weight:700;font-size:16px}
  .qr-stage {
  width: 420px;
  min-height: 420px;
  aspect-ratio: 1 / 1; /* ‚¨ÖÔ∏è square ratio ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá */
  border-radius: 12px;
  background: linear-gradient(180deg, rgba(0, 0, 0, 0.071), rgba(255, 255, 255, 0.053));
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden; /* ‚úÖ canvas ‡¶®‡¶ø‡¶ö‡ßá ‡¶®‡¶æ‡¶Æ‡¶≤‡ßá ‡¶¶‡¶æ‡¶ó ‡¶≤‡ßÅ‡¶ï‡¶ø‡ßü‡ßá ‡¶¶‡ßá‡¶¨‡ßá */
}

/* frame wraps around - position via CSS transform with tx/ty offsets */
  .frame-img {
    cursor: move;
  transition: transform 0.1s ease;
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(calc(-50% + var(--tx, 0px)), calc(-50% + var(--ty, 0px)));
  z-index: 2; /* changed from 0 */
  pointer-events: auto;
  user-select: none;
  max-width: 180%;
  max-height: 180%;
}
.qrCanvas {
  position: relative;
  z-index: 1;
  pointer-events: none;
}
.drag-hint {
  position: absolute;
  bottom: 6px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.4);
  padding: 2px 8px;
  border-radius: 6px;
  color: #ccc;
  font-size: 12px;
}

  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .note{font-size:13px;color:var(--muted)}
  .group-title{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .footer-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  input[type=file]{padding:8px}
  input[type=range]{width:100%}
  .toggle{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
  .small-muted{font-size:12px;color:var(--muted)}
  /* --- Header Styling --- */
/* --- Header Styling --- */
header {
  width: 100%;
  text-align: center;
  margin-bottom: 10px;
  position: fixed;        /* ‡¶â‡¶™‡¶∞‡ßá ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
  top: 0;                 /* ‡¶è‡¶ï‡¶¶‡¶Æ ‡¶â‡¶™‡¶∞‡ßá */
  left: 0;
  background:linear-gradient(180deg, rgba(0, 11, 61, 0.342),rgba(0, 109, 187, 0.616), rgba(0, 13, 69, 0.352));
  box-shadow:0 6px 18px rgba(2,6,23,0.6);
  backdrop-filter: blur(6px);       /* ‡¶π‡¶æ‡¶≤‡¶ï‡¶æ ‡¶¨‡ßç‡¶≤‡¶æ‡¶∞ ‡¶á‡¶´‡ßá‡¶ï‡ßç‡¶ü */
  padding: 8px 0;
  z-index: 1000;          /* ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶∏‡¶¨ ‡¶ï‡¶®‡¶ü‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶â‡¶™‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
  border-bottom: 1px solid rgba(255, 255, 255, 0.194);
}
header .title {
  font-size: 28px;
  font-weight: 700;
  background: linear-gradient(90deg, #f6fac2, #81fff9);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
header .sub {
  font-size: 14px;
  color: #a0cbff;
}

/* --- QR and Quick Actions alignment --- */
.qr-actions-layout {
  display: flex;
  align-items: flex-start;
  justify-content: center;
  gap: 40px; /* ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ */
  flex-wrap: nowrap;
  width: 100%;
}
.qr-stage {
  flex-shrink: 0;
}

.actions-right {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: flex-start;
  gap: 12px;
  min-width: 200px;
}

.actions-right .muted {
  text-align: left;
}

 /* üåê Enhanced Mobile-Friendly Styles */
/* üåê Enhanced Mobile-Friendly Styles (Updated) */
@media (max-width: 900px) {

  body {
    padding: 12px;
    padding-top: 100px;
    flex-direction: column;
    align-items: center;
  }

  header {
    padding: 10px 0;
  }
  header .title {
    font-size: 22px;
  }
  header .sub {
    font-size: 12px;
  }

  .container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    gap: 24px;
  }

  /* --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ (‡¶∂‡ßÅ‡¶∞‡ßÅ) --- */

  .wrap {
    /* ‡¶ï‡¶≤‡¶æ‡¶Æ ‡¶¶‡ßÅ‡¶ü‡¶ø‡¶ï‡ßá ‡¶è‡¶ï‡¶ü‡¶ø‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá ‡¶Ü‡¶∞‡ßá‡¶ï‡¶ü‡¶ø ‡¶®‡¶ø‡ßü‡ßá ‡¶Ü‡¶∏‡ßÅ‡¶® */
    grid-template-columns: 1fr;
    width: 100%;
    gap: 24px;
  }

  .card {
    width: 100%;
    max-width: 90%;
    padding: 18px;
    margin: 0 auto;
    height: auto; /* ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® */
  }

  /* Control panel scrollable for small screens */
  .card:not(.preview-area) {
     max-height: 65vh; /* ‡¶≠‡¶ø‡¶â‡¶™‡ßã‡¶∞‡ßç‡¶ü‡ßá‡¶∞ 65% ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶≤‡¶Æ‡ßç‡¶¨‡¶æ ‡¶π‡¶¨‡ßá ‡¶®‡¶æ */
     overflow-y: auto;
  }

  input, select, button, textarea { /* 'textarea' ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá */
    width: 100%;
    font-size: 16px;
    padding: 10px;
    border-radius: 8px;
  }

  /* QR Preview adjustments */
  .preview-card {
    max-width: 95%;
    padding: 20px;
  }

  .qr-layout {
    flex-direction: column;
    gap: 16px;
    align-items: center;
  }
  
  .qr-actions-layout {
    /* QR ‡¶ï‡ßã‡¶° ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶æ‡¶ü‡¶®‡¶ó‡ßÅ‡¶≤‡ßã‡¶ï‡ßá ‡¶è‡¶ï‡¶ü‡¶ø‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá ‡¶Ü‡¶∞‡ßá‡¶ï‡¶ü‡¶ø ‡¶∏‡¶æ‡¶ú‡¶æ‡¶® */
    flex-direction: column;
    align-items: center;
    gap: 24px;
  }
  
  .controls {
    /* ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶á‡¶ú/‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶≤‡ßá‡¶ñ‡¶æ */
    flex-direction: column;
    gap: 4px;
    align-items: center;
  }

  .qr-stage {
    width: 280px;
    height: 280px;
  }

  .actions-right {
    width: 100%;
    align-items: center;
    justify-content: center;
  }

  .actions-right .btn {
    width: 90%;
    justify-content: center;
  }
  
  .actions-right .note,
  .actions-right div {
      width: 100%;
      max-width: 280px;
      text-align: center;
  }

  .muted {
    text-align: center;
    width: 100%;
  }

  .btn {
    font-size: 15px;
    padding: 10px 14px;
  }
  
  /* --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ (‡¶∂‡ßá‡¶∑) --- */
}

  /* small hint for draggable */
  .drag-hint { position:absolute; bottom:8px; left:8px; font-size:12px; color:var(--muted); z-index:3 }

  /* --- üîΩ ADD THESE MODAL STYLES üîΩ --- */

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(9, 1, 55, 0.701);
  backdrop-filter: blur(8px);
  display: none; /* Hidden by default */
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
}

.modal-content {
  background: #010128;
  border: 5px solid hsl(55, 92%, 95%);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: 0 10px 40px rgb(0, 216, 216);
  width: 100%;
  max-width: 450px;
}

.modal-content h2 {
  margin-top: 0;
}

.modal-content label {
  margin-top: 12px;
}

.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 24px;
  justify-content: flex-end;
}

/* Ensure modal buttons don't stretch */
.modal-actions .btn {
  width: auto;
}

/* Mobile styles for modal */
@media (max-width: 900px) {
  .modal-actions {
    flex-direction: column-reverse; /* Stack buttons */
  }
  .modal-actions .btn {
    width: 100%; /* Make buttons full-width */
    justify-content: center;
  }
} 
</style>

</head>
<body>
  <header>
    <div>
      <div class="title">QR Code Generator</div>
      <div class="sub">Make Your QR Code with stylish</div>
    </div>
  </header>
<div class="content-wrap">
  <div class="wrap">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
        <h1><a href="qr-generator.html">‚öôÔ∏è</a> Control Panel</h1>
      </div>
      <div style="text-align:right">
        <button id="resetBtn" class="btn ghost">Reset All</button>
      </div>
    </div>

    <label>Text / URL</label>
    <input id="text" type="text" value="https://bhabatosh-qrcode-generator.com">

    <div class="row" style="margin-top:8px">
      <div>
        <label>Size (px)</label>
        <input id="size" type="number" min="128" max="2048" value="350">
      </div>
      <div style="width:120px">
        <label>Margin (px)</label>
        <input id="margin" type="number" min="0" max="200" value="10">
      </div>
    </div>

    <label>Code Density</label>
    <select id="ec">
      <option value="L">Low Code</option>
      <option value="M" selected>Middium Code</option>
      <option value="Q">Quality Code</option>
      <option value="H">High Code</option>
    </select>

    <hr style="margin:12px 0;border:none;height:1px;background:rgba(255,255,255,0.02)">

    <h3 style="margin:8px 0 0">üé® Body Dots Shape</h3>
    <label>Body Shape (dotsOptions.type)</label>
    <select id="bodyShape">
      <option value="extra-rounded">Extra rounded</option>
      <option value="square">QR (square)</option>
      <option value="rounded">Rounded</option>
      <option value="dots">Dots</option>
      <option value="classy">Classy</option>
      <option value="classy-rounded">Classy rounded</option>
    </select>
    <label>Body Colors</label>
    <div class="row">
      <input type="color" id="bodyGrad1" value="#ff1900">
      <input type="color" id="bodyGrad2" value="#1100ff">
    </div>
    <label>Body Gradient Type</label>
    <select id="bodyGradType">
      <option value="radial">Radial</option>
      <option value="linear">Linear</option>
    </select>

    <h3 style="margin-top:8px">üëÅ Eye Frame</h3>
    <label>Eye Frame Shape</label>
    <select id="eyeFrame">
      <option value="extra-rounded">Extra rounded</option>
      <option value="classy-rounded">Classy rounded</option>
      <option value="square">QR (square)</option>
      <option value="dot">Dot</option>
      <option value="rounded">Rounded</option>
      <option value="dots">Dots</option>
      <option value="classy">Classy</option>
    </select>
    <label>Eye Frame Colors</label>
    <div class="row">
      <input type="color" id="eyeFrameGrad1" value="#ff0000">
      <input type="color" id="eyeFrameGrad2" value="#03d100">
    </div>
    <label>Eye Frame Gradient Type</label>
    <select id="eyeFrameGradType">
      <option value="linear">Linear</option>
      <option value="radial">Radial</option>
    </select>

    <h3 style="margin-top:8px">üëÅ Eye Ball</h3>
    <label>Eye Ball Shape</label>
    <select id="eyeBall">
      <option value="extra-rounded">Extra rounded</option>
      <option value="classy-rounded">Classy rounded</option>
      <option value="dot">QR (dot)</option>
      <option value="square">Square</option>
      <option value="rounded">Rounded</option>
      <option value="dots">Dots</option>
      <option value="classy">Classy</option>
      
    </select>
    <label>Eye Ball Colors</label>
    <div class="row">
      <input type="color" id="eyeBallGrad1" value="#00b3ff">
      <input type="color" id="eyeBallGrad2" value="#8c00ff">
    </div>
    <label>Eye Ball Gradient Type</label>
    <select id="eyeBallGradType">
      <option value="linear">Linear</option>
      <option value="radial">Radial</option>
    </select>

    <hr style="margin:12px 0;border:none;height:1px;background:rgba(255,255,255,0.02)">

    <h3>üñº Logo</h3>
    <label>Logo image</label>
    <input type="file" id="logoFile" accept="image/*">
    <label style="margin-top:6px"><input type="checkbox" id="logoBgRemove"> Remove background behind logo (hide dots under image)</label>
    <label>Logo Size (%) ‚Äî recommended ‚â§50%</label>
    <input type="range" id="logoSize" min="10" max="80" value="30">

    <h3 style="margin-top:8px">üñº Frame</h3>
<div class="row" style="margin-top:8px">
  <div>
    <label>Select Frame</label>
    <select id="frameSelect">
      <option value="none">None</option>
      <option value="frame1">üåø Green Grass Frame</option>
      <option value="frame2">üå∏ Floral Rose Frame</option>
      <option value="frame3">üî• Fire Glow Frame</option>
    </select>
  </div>
  <div>
    <label style="margin-top:12px;">Custom Frame</label>
    <input type="file" id="frameFile" accept="image/*">
    <div class="small-muted" style="margin-top:4px;">Uploading a file will override the selection above.</div>
  </div>
</div>

<!-- üñº Hidden Frame Library -->
<div id="frameLibrary" style="display:none">
  <img data-frame="frame1" src="qr framm.jpg" alt="Green Grass Frame">
  <img data-frame="frame2" src="frm.jpg" alt="Floral Rose Frame">
  <img data-frame="frame3" src="frames/fire.png" alt="Fire Frame">
</div>

<label style="margin-top:12px;">Frame Size (%) ‚Äî >100% wraps beyond QR</label>
<input type="range" id="frameSize" min="100" max="180" value="110">
<label style="margin-top:6px">
  <input type="checkbox" id="showFrame" checked> Show Frame in preview & download
</label>
<div class="small-muted" style="margin-top:6px">
  Drag the frame in preview to reposition it.
</div>

    <h3 style="margin-top:8px">üé® Background</h3>
    <label>Background Color (canvas)</label>
    <input type="color" id="bg" value="#ffffff">
    <label style="margin-top:8px"><input type="checkbox" id="transparentBg"> Make QR Background Transparent</label>

    <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="generate" class="btn">Generate</button>
      
      <button id="downloadQrOnlyBtn" class="btn ghost">Download QR Only</button>

    </div>

    
  </div>

  <div class="card preview-area">
    <div class="preview-card" style="width:100%">
      <div class="designer" style="justify-content:space-between">
        <div>
          <div class="brand">QR Code Live Preview</div>
          <div class="small-muted"></div>
        </div>
        <div class="controls">
          <div class="small-muted">Size: <span id="previewSizeText">350</span>px</div>
          <div class="small-muted">Margin: <span id="previewMarginText">10</span>px</div>

        </div>
      </div>

      <div style="display:flex;gap:20px;margin-top:14px;flex-wrap:wrap">
        <div class="qr-actions-layout">
          <div class="qr-stage" id="stage" aria-hidden="true">
            <img id="frameImg" class="frame-img" src="" style="display:none" alt="frame">
            <div class="drag-hint"></div>
            <div id="qrCanvas" class="qrCanvas"></div>
          </div>

          <div class="actions-right">
            <div class="muted"><strong>Quick actions</strong></div>
            <button id="regenBtn" class="btn ghost">Regenerate Preview</button>
            <button id="centerBtn" class="btn ghost">Center Frame</button>
            <div>Software Desined by<strong> BHABATOSH BARMAN</strong></div>
            <div style="margin-top:12px" class="note">If you want more updates, WhatsApp directly on this number 9064899089</div>
            <button id="downloadBtn" class="btn">Download QR</button>
          </div>
          
        </div>

      </div>

    </div>
  </div>
</div>
</div>

<div id="downloadModal" class="modal-overlay">
  <div class="modal-content">
    <h2>Download Options</h2>
    <p class="muted">Select your desired size and format.</p>
    
    <label for="downloadFormat">Format</label>
    <select id="downloadFormat">
      <option value="png" selected>PNG (Recommended)</option>
      <option value="jpg">JPG (Smaller file size)</option>
      <option value="svg">SVG (Vector - QR only)</option>
    </select>

    <label for="downloadSize">Size (px)</label>
    <input type="number" id="downloadSize" value="1024" min="256" max="4096">
    
    <div class="modal-actions">
      <button id="closeModalBtn" class="btn ghost">Cancel</button>
      <button id="confirmDownloadBtn" class="btn">Confirm & Download</button>
    </div>
    
    <div id="svgWarning" class="small-muted" style="display:none; margin-top:10px;">
      <strong>Note:</strong> SVG format only supports the QR code itself, not the custom frame. If a frame is active, it will be ignored for SVG download.
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.9.2/lib/qr-code-styling.js"></script>
<script>
  // --- Disable right-click and inspection shortcuts (optional protection) ---
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  if (
    e.key === 'F12' ||
    (e.ctrlKey && e.shiftKey && e.key === 'I') ||
    (e.ctrlKey && e.key === 'U')
  ) {
    e.preventDefault();
  }
});

/* ---------- Helper to build either color OR gradient object ---------- */
function buildColorOrGradient(c1, c2, gradType) {
  if (!c1) c1 = '#000';
  if (!c2) c2 = c1;
  if (c1.toLowerCase() === c2.toLowerCase()) {
    return { color: c1 };
  }
  return {
    gradient: {
      type: gradType === 'radial' ? 'radial' : 'linear',
      rotation: 0,
      colorStops: [
        { offset: 0, color: c1 },
        { offset: 1, color: c2 }
      ]
    }
  };
}

async function loadImageSafe(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();

    // üß† Only use crossOrigin if it's NOT a local file path
    if (!src.startsWith("data:") && !src.startsWith("blob:") && !src.startsWith("frames/") && !src.startsWith("./") && !src.startsWith("/")) {
      img.crossOrigin = "anonymous";
    }

    img.onload = () => resolve(img);
    img.onerror = (err) => reject(err);
    img.src = src;
  });
}


/* Define qr globally, but initialize it inside window.onload */
let qr; 
const qrContainer = document.getElementById("qrCanvas");

/* Cached DOM */
const els = {
  frameSelect: document.getElementById('frameSelect'),
  text: document.getElementById('text'),
  size: document.getElementById('size'),
  margin: document.getElementById('margin'),
  ec: document.getElementById('ec'),
  bodyShape: document.getElementById('bodyShape'),
  bodyGrad1: document.getElementById('bodyGrad1'),
  bodyGrad2: document.getElementById('bodyGrad2'),
  bodyGradType: document.getElementById('bodyGradType'),
  eyeFrame: document.getElementById('eyeFrame'),
  eyeFrameGrad1: document.getElementById('eyeFrameGrad1'),
  eyeFrameGrad2: document.getElementById('eyeFrameGrad2'),
  eyeFrameGradType: document.getElementById('eyeFrameGradType'),
  eyeBall: document.getElementById('eyeBall'),
  eyeBallGrad1: document.getElementById('eyeBallGrad1'),
  eyeBallGrad2: document.getElementById('eyeBallGrad2'),
  eyeBallGradType: document.getElementById('eyeBallGradType'),
  logoFile: document.getElementById('logoFile'),
  logoBgRemove: document.getElementById('logoBgRemove'),
  logoSize: document.getElementById('logoSize'),
  frameFile: document.getElementById('frameFile'),
  frameSize: document.getElementById('frameSize'),
  showFrame: document.getElementById('showFrame'),
  bg: document.getElementById('bg'),
  transparentBg: document.getElementById('transparentBg'),
  generate: document.getElementById('generate'),
  downloadBtn: document.getElementById('downloadBtn'),
  downloadQrOnlyBtn: document.getElementById('downloadQrOnlyBtn'),
  qrCanvasDiv: document.getElementById('qrCanvas'),
  frameImgEl: document.getElementById('frameImg'),
  previewSizeText: document.getElementById('previewSizeText'),
  previewMarginText: document.getElementById('previewMarginText'),
  resetBtn: document.getElementById('resetBtn'),
  regenBtn: document.getElementById('regenBtn'),
  centerBtn: document.getElementById('centerBtn'),
  stage: document.getElementById('stage'),
  // Modal elements
  downloadModal: document.getElementById('downloadModal'),
  closeModalBtn: document.getElementById('closeModalBtn'),
  confirmDownloadBtn: document.getElementById('confirmDownloadBtn'),
  downloadFormat: document.getElementById('downloadFormat'),
  downloadSize: document.getElementById('downloadSize'),
  svgWarning: document.getElementById('svgWarning')
};

/* Defaults */
const DEFAULTS = {
  text: "https://bhabatosh-qrcode-generator.com",
  size: 400,
  margin: 10,
  ec: "M",
  bodyShape: "square",
  bodyGrad1: "#ff1900", // Adjusted body defaults to match the HTML input values
  bodyGrad2: "#1100ff",
  bodyGradType: "linear",
  eyeFrame: "square",
  eyeFrameGrad1: "#ff0000",
  eyeFrameGrad2: "#03d100",
  eyeFrameGradType: "linear",
  eyeBall: "dot",
  eyeBallGrad1: "#00b3ff",
  eyeBallGrad2: "#8c00ff",
  eyeBallGradType: "linear",
  logoSize: 30,
  logoBgRemove: false,
  frameSize: 110,
  showFrame: true,
  bg: "#ffffff",
  transparentBg: false
};

/* Update preview labels */
function updatePreviewLabels() {
  if (els.previewSizeText) els.previewSizeText.textContent = els.size.value;
  if (els.previewMarginText) els.previewMarginText.textContent = els.margin.value;
}

/* Load image from file */
function loadImageFromFile(file) {
  return new Promise((res, rej) => {
    if (!file) return res(null);
    const img = new Image();
    img.crossOrigin = "anonymous"; // ‚úÖ Prevent canvas tainting
    const reader = new FileReader();
    reader.onload = function (e) {
      img.onload = () => res(img);
      img.onerror = (err) => rej(err);
      img.src = e.target.result;
    };
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}


/* Convert PNG ‚Üí JPG */
function convertPngToJpg(pngDataUrl, background) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = background || '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);
      resolve(canvas.toDataURL('image/jpeg', 0.9));
    };
    img.onerror = reject;
    img.src = pngDataUrl;
  });
}

/* Variables */
let lastFrameImage = null;
let lastLogoImage = null;
let frameOffset = { x: 0, y: 0 };
let dragging = false;
let dragStart = { x: 0, y: 0 };
let startOffset = { x: 0, y: 0 };

/* Update QR Preview */
async function updateQR() {
  // Check if QR object is initialized
  if (!qr) {
      console.error("QR Code Styling library is not yet initialized.");
      return;
  }
  
  updatePreviewLabels();

  const size = Number(els.size.value) || 400;
  const margin = Number(els.margin.value) || 0;
  const data = els.text.value || "";
  const ec = els.ec.value || "M";

  const bodyType = els.bodyShape.value;
  const bodyGrad1 = els.bodyGrad1.value;
  const bodyGrad2 = els.bodyGrad2.value;
  const bodyGradType = els.bodyGradType.value;

  const eyeFrameType = els.eyeFrame.value;
  const eyeFrameGrad1 = els.eyeFrameGrad1.value;
  const eyeFrameGrad2 = els.eyeFrameGrad2.value;
  const eyeFrameGradType = els.eyeFrameGradType.value;

  const eyeBallType = els.eyeBall.value;
  const eyeBallGrad1 = els.eyeBallGrad1.value;
  const eyeBallGrad2 = els.eyeBallGrad2.value;
  const eyeBallGradType = els.eyeBallGradType.value;

  const transparentBg = els.transparentBg.checked;
  const bgColor = els.bg.value || "#ffffff";

  const config = {
    width: size,
    height: size,
    margin: margin,
    data: data,
    qrOptions: { errorCorrectionLevel: ec },
    backgroundOptions: transparentBg
      ? { color: "transparent" }
      : buildColorOrGradient(bgColor, bgColor, "linear"),
    dotsOptions: Object.assign(
      { type: bodyType },
      buildColorOrGradient(bodyGrad1, bodyGrad2, bodyGradType)
    ),
    cornersSquareOptions: Object.assign(
      { type: eyeFrameType },
      buildColorOrGradient(eyeFrameGrad1, eyeFrameGrad2, eyeFrameGradType)
    ),
    cornersDotOptions: Object.assign(
      { type: eyeBallType },
      buildColorOrGradient(eyeBallGrad1, eyeBallGrad2, eyeBallGradType)
    )
  };

  // Handle logo
  const logoFile = els.logoFile?.files?.[0];
  if (logoFile) {
    const logoImg = await loadImageFromFile(logoFile);
    if (logoImg) {
      const tmp = document.createElement('canvas');
      tmp.width = logoImg.width;
      tmp.height = logoImg.height;
      tmp.getContext('2d').drawImage(logoImg, 0, 0);
      config.image = tmp.toDataURL('image/png');
      config.imageOptions = {
        crossOrigin: "anonymous",
        margin: els.logoBgRemove.checked ? 0 : 8,
        hideBackgroundDots: !!els.logoBgRemove.checked,
        imageSize: Math.max(
          0.01,
          Math.min(0.95, Number(els.logoSize.value) / 100)
        )
      };
      lastLogoImage = logoImg;
    }
  } else {
    config.image = undefined;
    lastLogoImage = null;
  }

  // Update main QR
  qr.update(config);

// FRAME SELECTION (HTML library or custom upload)
const frameFile = els.frameFile?.files?.[0];
const selectedKey = els.frameSelect.value;
let selectedFrameImg = null;

// 1Ô∏è‚É£ Custom upload highest priority
if (frameFile) {
  selectedFrameImg = await loadImageFromFile(frameFile);
}
// 2Ô∏è‚É£ Otherwise pick from hidden HTML frame library
else if (selectedKey && selectedKey !== "none") {
  const libImg = document.querySelector(`#frameLibrary img[data-frame="${selectedKey}"]`);
  if (libImg) {
    const tmp = new Image();
    tmp.src = libImg.src;
    await new Promise((r, j) => {
      tmp.onload = () => r();
      tmp.onerror = () => j();
    });
    selectedFrameImg = tmp;
  }
}

// 3Ô∏è‚É£ Apply frame if any
if (selectedFrameImg && els.showFrame.checked) {
  lastFrameImage = selectedFrameImg;
  els.frameImgEl.src = selectedFrameImg.src;
  els.frameImgEl.style.display = "block";
  const pct = Number(els.frameSize.value) || 110;
  const stageRect = els.stage.getBoundingClientRect();
  const base = Math.min(stageRect.width, stageRect.height);
  els.frameImgEl.style.width = (pct / 100) * base + "px";
  els.frameImgEl.style.height = "auto";
  els.frameImgEl.style.setProperty("--tx", frameOffset.x + "px");
  els.frameImgEl.style.setProperty("--ty", frameOffset.y + "px");
} else {
  els.frameImgEl.style.display = "none";
  lastFrameImage = null;
}
}


/* Compose merged PNG */
async function composeMergedPNG() {
  // slight wait to ensure QR rendering completed (library is async)
  await new Promise(r => setTimeout(r, 120));
  const qrElem = qrContainer.querySelector('canvas') || qrContainer.querySelector('svg');
  if (!qrElem) throw new Error('QR output not found. Please generate it first.');

  const qrSize = Number(els.size.value) || 400;
  let frameLeft = 0, frameTop = 0, frameRight = qrSize, frameBottom = qrSize;

  if (lastFrameImage && els.showFrame.checked) {
    const framePct = Number(els.frameSize.value) || 110;
    const targetWidth = (framePct / 100) * qrSize;
    const scale = targetWidth / lastFrameImage.width;
    const drawW = lastFrameImage.width * scale;
    const drawH = lastFrameImage.height * scale;
    const cx = qrSize / 2 + frameOffset.x;
    const cy = qrSize / 2 + frameOffset.y;
    frameLeft = cx - drawW / 2;
    frameTop = cy - drawH / 2;
    frameRight = cx + drawW / 2;
    frameBottom = cy + drawH / 2;
  }

  const canvasLeft = Math.min(0, frameLeft);
  const canvasTop = Math.min(0, frameTop);
  const canvasRight = Math.max(qrSize, frameRight);
  const canvasBottom = Math.max(qrSize, frameBottom);
  const canvasWidth = canvasRight - canvasLeft;
  const canvasHeight = canvasBottom - canvasTop;

  const outCanvas = document.createElement('canvas');
  outCanvas.width = canvasWidth;
  outCanvas.height = canvasHeight;
  const outCtx = outCanvas.getContext('2d');

  if (!els.transparentBg.checked) {
    outCtx.fillStyle = els.bg.value || '#ffffff';
    outCtx.fillRect(0, 0, canvasWidth, canvasHeight);
  } else {
    outCtx.clearRect(0, 0, canvasWidth, canvasHeight);
  }

  // Draw frame first
  if (lastFrameImage && els.showFrame.checked) {
    const framePct = Number(els.frameSize.value) || 110;
    const targetWidth = (framePct / 100) * qrSize;
    const scale = targetWidth / lastFrameImage.width;
    const drawW = lastFrameImage.width * scale;
    const drawH = lastFrameImage.height * scale;
    const cx = qrSize / 2 + frameOffset.x;
    const cy = qrSize / 2 + frameOffset.y;
    outCtx.drawImage(lastFrameImage, cx - drawW / 2 - canvasLeft, cy - drawH / 2 - canvasTop, drawW, drawH);
  }

  // Draw QR
  if (qrElem.tagName.toLowerCase() === 'canvas') {
    outCtx.drawImage(qrElem, -canvasLeft, -canvasTop, qrSize, qrSize);
  } else {
    const svgBlob = new Blob([qrElem.outerHTML], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(svgBlob);
    const img = new Image();
    img.crossOrigin = 'anonymous';
    await new Promise((resolve, reject) => {
      img.onload = () => {
        outCtx.drawImage(img, -canvasLeft, -canvasTop, qrSize, qrSize);
        URL.revokeObjectURL(url);
        resolve();
      };
      img.onerror = e => { URL.revokeObjectURL(url); reject(e); };
      img.src = url;
    });
  }

  return outCanvas.toDataURL('image/png');
}

/* Trigger file download */
function triggerDownload(dataUrl, filename = 'qr-image.png') {
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* --- Event Listeners --- */
// Event listeners remain outside window.onload for immediate attachment, 
// but ensure they check if 'qr' is initialized before calling 'updateQR'.

els.generate.addEventListener('click', async () => {
  try { await updateQR(); } catch (e) { alert('Failed to update QR: ' + (e?.message || e)); }
});

els.regenBtn.addEventListener('click', updateQR);

els.centerBtn.addEventListener('click', () => {
  frameOffset = { x: 0, y: 0 };
  if (els.frameImgEl) {
    els.frameImgEl.style.setProperty('--tx', '0px');
    els.frameImgEl.style.setProperty('--ty', '0px');
  }
});


/* Download modal handling */
els.downloadBtn.addEventListener('click', () => {
  if (!qr) return alert("QR Generator is still loading. Please wait a moment.");
  if (els.downloadSize) els.downloadSize.value = els.size.value;
  if (els.svgWarning) els.svgWarning.style.display = lastFrameImage && els.showFrame.checked ? 'block' : 'none';
  if (els.downloadModal) els.downloadModal.style.display = 'flex';
});
if (els.closeModalBtn) els.closeModalBtn.addEventListener('click', () => els.downloadModal.style.display = 'none');
if (els.downloadModal) els.downloadModal.addEventListener('click', e => { if (e.target === els.downloadModal) els.downloadModal.style.display = 'none'; });

if (els.confirmDownloadBtn) {
  els.confirmDownloadBtn.addEventListener('click', async () => {
    const format = els.downloadFormat.value;
    const targetSize = Number(els.downloadSize.value);
    const originalSize = els.size.value;
    const btn = els.confirmDownloadBtn;
    const originalBtnText = btn.textContent;
    btn.textContent = 'Generating...';
    btn.disabled = true;
    try {
      if (format === 'svg') {
        qr.update({ width: targetSize, height: targetSize });
        await qr.download({ name: 'Bhabatosh-Qr', extension: 'svg' });
        qr.update({ width: originalSize, height: originalSize });
      } else {
        // Temporarily set preview size to render high-res
        els.size.value = targetSize;
        await updateQR();
        let dataUrl = await composeMergedPNG();
        // Restore preview size
        els.size.value = originalSize;
        await updateQR();
        if (format === 'jpg') {
          const bgColor = els.transparentBg.checked ? '#ffffff' : els.bg.value;
          dataUrl = await convertPngToJpg(dataUrl, bgColor);
        }
        triggerDownload(dataUrl, `Bhabatosh-Qr.${format}`);
      }
      if (els.downloadModal) els.downloadModal.style.display = 'none';
    } catch (e) {
      alert('Download failed: ' + (e?.message || e));
      els.size.value = originalSize;
      await updateQR();
    } finally {
      btn.textContent = originalBtnText;
      btn.disabled = false;
    }
  });
}

/* Download QR only */
if (els.downloadQrOnlyBtn) {
  els.downloadQrOnlyBtn.addEventListener('click', async () => {
    try {
      if (!qr) return alert("QR Generator is still loading. Please wait a moment.");
      await updateQR();
      const qrElem = qrContainer.querySelector('canvas') || qrContainer.querySelector('svg');
      if (!qrElem) return alert('Generate QR first!');
      if (qrElem.tagName.toLowerCase() === 'canvas') {
        triggerDownload(qrElem.toDataURL('image/png'), 'qr-only.png');
      } else {
        const svgBlob = new Blob([qrElem.outerHTML], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(svgBlob);
        const img = new Image();
        img.onload = () => {
          const c = document.createElement('canvas');
          c.width = Number(els.size.value) || 400;
          c.height = Number(els.size.value) || 400;
          c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
          URL.revokeObjectURL(url);
          triggerDownload(c.toDataURL('image/png'), 'qr-only.png');
        };
        img.onerror = (err) => { URL.revokeObjectURL(url); alert('Failed to convert svg'); };
        img.src = url;
      }
    } catch (e) {
      alert('Download QR only failed: ' + (e?.message || e));
    }
  });
}

/* Update preview when relevant inputs change (live controls) */
const liveControls = [
  'text','size','margin','bodyShape','bodyGrad1','bodyGrad2','bodyGradType',
  'eyeFrame','eyeFrameGrad1','eyeFrameGrad2','eyeFrameGradType',
  'eyeBall','eyeBallGrad1','eyeBallGrad2','eyeBallGradType',
  'bg','logoBgRemove','logoSize','frameSize','showFrame','transparentBg','ec','frameSelect'
];

// safe attach listeners (some elements might be missing)
liveControls.forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('input', updateQR);
  el.addEventListener('change', updateQR);
});

/* Reset to defaults */
if (els.resetBtn) {
  els.resetBtn.addEventListener('click', () => {
    els.text.value = DEFAULTS.text;
    els.size.value = DEFAULTS.size;
    els.margin.value = DEFAULTS.margin;
    els.ec.value = DEFAULTS.ec;
    els.bodyShape.value = DEFAULTS.bodyShape;
    els.bodyGrad1.value = DEFAULTS.bodyGrad1;
    els.bodyGrad2.value = DEFAULTS.bodyGrad2;
    els.bodyGradType.value = DEFAULTS.bodyGradType;
    els.eyeFrame.value = DEFAULTS.eyeFrame;
    els.eyeFrameGrad1.value = DEFAULTS.eyeFrameGrad1;
    els.eyeFrameGrad2.value = DEFAULTS.eyeFrameGrad2;
    els.eyeFrameGradType.value = DEFAULTS.eyeFrameGradType;
    els.eyeBall.value = DEFAULTS.eyeBall;
    els.eyeBallGrad1.value = DEFAULTS.eyeBallGrad1;
    els.eyeBallGrad2.value = DEFAULTS.eyeBallGrad2;
    els.eyeBallGradType.value = DEFAULTS.eyeBallGradType;
    els.logoSize.value = DEFAULTS.logoSize;
    els.logoBgRemove.checked = DEFAULTS.logoBgRemove;
    els.frameSize.value = DEFAULTS.frameSize;
    els.showFrame.checked = DEFAULTS.showFrame;
    els.bg.value = DEFAULTS.bg;
    els.transparentBg.checked = DEFAULTS.transparentBg;
    // clear file inputs safely
    if (els.frameFile) els.frameFile.value = '';
    if (els.logoFile) els.logoFile.value = '';
    els.frameSelect.value = "none";
    // hide preview frame and reset offsets
    if (els.frameImgEl) els.frameImgEl.style.display = 'none';
    lastFrameImage = null;
    lastLogoImage = null;
    frameOffset = { x: 0, y: 0 };
    if (els.frameImgEl) {
      els.frameImgEl.style.setProperty('--tx', '0px');
      els.frameImgEl.style.setProperty('--ty', '0px');
    }
    updateQR();
  });
}

/* File change handlers */
if (els.frameFile) {
  els.frameFile.addEventListener('change', async () => {
    els.frameSelect.value = "none"; // clear select if custom file uploaded
    frameOffset = { x: 0, y: 0 };
    if (els.frameImgEl) {
      els.frameImgEl.style.setProperty('--tx', '0px');
      els.frameImgEl.style.setProperty('--ty', '0px');
    }
    await updateQR();
  });
}
if (els.logoFile) {
  els.logoFile.addEventListener('change', async () => {
    await updateQR();
  });
}

/* Draggable frame implementation */
function getPointer(e) {
  if (e.touches && e.touches.length) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
  return { x: e.clientX, y: e.clientY };
}
if (els.frameImgEl) {
  els.frameImgEl.addEventListener('mousedown', (e) => {
    e.preventDefault();
    dragging = true;
    dragStart = getPointer(e);
    startOffset = { x: frameOffset.x, y: frameOffset.y };
    els.frameImgEl.style.zIndex = 5;
  });
}
window.addEventListener('mousemove', (e) => {
  if (!dragging) return;
  const p = getPointer(e);
  const dx = p.x - dragStart.x;
  const dy = p.y - dragStart.y;
  frameOffset.x = startOffset.x + dx;
  frameOffset.y = startOffset.y + dy;
  if (els.frameImgEl) {
    els.frameImgEl.style.setProperty('--tx', frameOffset.x + 'px');
    els.frameImgEl.style.setProperty('--ty', frameOffset.y + 'px');
  }
});
window.addEventListener('mouseup', () => {
  if (!dragging) return;
  dragging = false;
  if (els.frameImgEl) els.frameImgEl.style.zIndex = 0;
});
/* touch handlers */
if (els.frameImgEl) {
  els.frameImgEl.addEventListener('touchstart', (e) => {
    e.preventDefault();
    dragging = true;
    const p = getPointer(e);
    dragStart = p;
    startOffset = { x: frameOffset.x, y: frameOffset.y };
    els.frameImgEl.style.zIndex = 5;
  }, { passive: false });
}
window.addEventListener('touchmove', (e) => {
  if (!dragging) return;
  const p = getPointer(e);
  const dx = p.x - dragStart.x;
  const dy = p.y - dragStart.y;
  frameOffset.x = startOffset.x + dx;
  frameOffset.y = startOffset.y + dy;
  if (els.frameImgEl) {
    els.frameImgEl.style.setProperty('--tx', frameOffset.x + 'px');
    els.frameImgEl.style.setProperty('--ty', frameOffset.y + 'px');
  }
}, { passive: false });
window.addEventListener('touchend', () => {
  if (!dragging) return;
  dragging = false;
  if (els.frameImgEl) els.frameImgEl.style.zIndex = 0;
});


// ----------------------------------------------------------------
// ‚ö†Ô∏è FIX: Move QR initialization and initial render inside window.onload
// ----------------------------------------------------------------

window.addEventListener('load', () => {
    /* ------------ Initial QR instance ------------- */
    // This must run AFTER qr-code-styling.js has loaded
    qr = new QRCodeStyling({
      width: 400,
      height: 400,
      data: "https://bhabatosh-qrcode-generator.com",
      dotsOptions: { 
          type: "square",
          ...buildColorOrGradient(DEFAULTS.bodyGrad1, DEFAULTS.bodyGrad2, DEFAULTS.bodyGradType)
      },
      backgroundOptions: { color: DEFAULTS.bg },
      cornersSquareOptions: { 
          type: "square", 
          ...buildColorOrGradient(DEFAULTS.eyeFrameGrad1, DEFAULTS.eyeFrameGrad2, DEFAULTS.eyeFrameGradType)
      },
      cornersDotOptions: { 
          type: "dot", 
          ...buildColorOrGradient(DEFAULTS.eyeBallGrad1, DEFAULTS.eyeBallGrad2, DEFAULTS.eyeBallGradType)
      }
    });

    /* Append to preview container */
    qr.append(qrContainer);

    /* initial render */
    // Now that 'qr' is initialized and appended, call updateQR
    updateQR();
    
    console.log("QR Generator initialized successfully.");
});

</script>
</body>
</html>